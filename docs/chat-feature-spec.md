# 📚 Lingooo チャット機能 要件まとめ

## 1. 概要
- **目的**: 単語詳細ページや検索結果に紐づく「チャット」体験を提供し、ユーザーが任意の質問を通じて追加の例文・ニュアンス・学習ヒントを即座に得られるようにする。
- **対象画面**: `WordDetailPage`、`SearchPage`（将来的には他画面への拡張も想定）。
- **初期スコープ**: フロントエンドのセッション管理と UI 連携、バックエンド API のインターフェース定義。

## 2. ユースケース
1. ユーザーがチャット入力欄に自由テキストを入力 → AI が単語に基づいた解説や例文を返す。
2. 事前定義のクイック質問（語源・類義語など）をタップ → 自動送信され回答が返る。
3. AI 応答を受け取った後に follow-up を重ね、最大 5 往復程度の履歴を保持。
4. ネットワークエラー時はリトライ可能なメッセージを提示。

## 3. 機能要件
### 3.1 チャットセッション管理
- ページ種別と ID（例: `word:study`, `search:勉強`）をキーに履歴を保持。
- 画面遷移時に最新履歴を復元。メモリキャッシュ（短期）を必須とし、必要に応じて AsyncStorage への永続化を検討。
- 最大履歴件数: 5 メッセージペア（ユーザー＋AI）を目安にトリミング。

### 3.2 UI 挙動
- 送信直後にユーザーメッセージを即表示し、ローディング状態の AI バブルを出す。
- ストリーミング応答に対応し、チャンクを受信するたびにテキストを更新。
- 質問タグ（語源・類義語など）をタップした際は自動でセッションへ送信。
- エラー発生時はメッセージバブル内に原因とリトライボタンを表示。

### 3.3 API 要件
- フロントエンドからの直接 Gemini 呼び出しは禁止。自社バックエンドの `/chat/word` などに POST。
- リクエスト情報:
  - `sessionId`（必須・クライアント生成）
  - `scope`（`word` | `search`）
  - `identifier`（単語または検索クエリ）
  - `context`（WordDetail の JSON、サジェスト一覧など）
  - `messages`（過去履歴＋新規発話）
- レスポンス:
  - ストリーミング: `text` チャンク＋完了シグナル
  - ノンストリーミング fallback: 完了後の全文、必要なら follow-up 質問配列
- レート制御と認証のフックを設ける（ユーザー ID、IP 制限などはバックエンドで対応）。

## 4. AI 設計
### 4.1 プロンプト構造
- **System**: Lingooo の英語学習アシスタントとしての役割、出力スタイル（簡潔・学習重視）、日英併記ガイドライン。
- **Context**: 現在の単語情報（品詞、意味、例文、メトリクス）または検索候補リスト。
- **History**: 最新 5 往復を JSON 形式で添付。
- **User**: ユーザーの質問本文。

### 4.2 モデル選択
- 既存 `selectModel` の `chat` シナリオを活用。
- `free` ユーザー: Gemini Flash。
- `pro` ユーザー: 未来対応として Claude / Groq モデルへ差し替え可能な設計。

### 4.3 出力整形
- バックエンド側で Markdown → プレーンテキスト変換や、箇条書き整形。
- 必要に応じて follow-up 質問や補助カード（例: コロケーション一覧）を JSON で返却。

## 5. 技術設計（フロントエンド）
### 5.1 データレイヤ
- `services/api/chat.ts`: API クライアント。ストリーミング対応の `sendChatMessageStream` と通常レスポンス用 `sendChatMessage` を提供。
- `services/cache/chat-cache.ts`: チャット履歴のメモリキャッシュ。`setChatHistory`, `getChatHistory`, `appendChatMessage` などの API を持つ。

### 5.2 状態管理
- `contexts/chat-context.tsx`: React context でチャットセッションを管理。
- `hooks/use-chat-session.ts`: 画面から利用するためのカスタムフック。履歴取得・送信・ストリーミングイベントをラップ。

### 5.3 UI コンポーネント
- `components/ui/chat-section.tsx`: 新しい props
  - `messages`: { id, role, content, status }[]
  - `onSend(text)`
  - `onQuickQuestion(question)`
  - `isStreaming`, `error`, `onRetry`
- ストリーミング中は送信ボタンを停止し、キャンセル機能は今後検討。

## 6. ロードマップ
1. **Phase 1**: フロントの状態管理と API スタブ実装。UI からスタブを介してダミー応答を表示。
2. **Phase 2**: バックエンド統合（Serverless/API サーバー）。ストリーミング対応、Gemini キー安全化。
3. **Phase 3**: 履歴永続化、プロプラン機能、follow-up 自動提案などの拡張。

---
本ドキュメントはチャット機能実装時の共通参照とし、進捗に応じてアップデートします。
