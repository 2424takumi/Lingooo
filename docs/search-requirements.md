# 検索機能 要件定義

## 概要
ユーザーが検索バーに入力して検索ボタンを押した時、入力言語に応じて適切なページに遷移する機能。

## 機能要件

### 1. 入力検知
**要件**: ユーザーが検索バーに入力したテキストを取得する

#### 入力元
- HomePage（トップ画面）の検索バー
- 検索ボタンをタップ、またはキーボードの「検索」キーを押す

#### 入力値の検証
- [ ] 空文字の場合の処理
  - 空の場合は検索を実行しない
  - エラーメッセージを表示する？または何もしない？
- [ ] 最小文字数の制限
  - 1文字以上？
- [ ] 最大文字数の制限
  - 100文字まで？

---

### 2. 言語判定ロジック

**要件**: 入力されたテキストが日本語か外国語（主に英語）かを判定する

#### 2.1 日本語判定の基準
**日本語と判定する条件（いずれかを満たす）:**
- [ ] ひらがなを含む（あ-ん）
- [ ] カタカナを含む（ア-ン）
- [ ] 漢字を含む（CJK統合漢字）
- [ ] 全角英数字を含む

**判定方法の例:**
```javascript
function isJapanese(text) {
  // ひらがな: \u3040-\u309f
  // カタカナ: \u30a0-\u30ff
  // 漢字: \u4e00-\u9faf
  const japaneseRegex = /[\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf]/;
  return japaneseRegex.test(text);
}
```

#### 2.2 外国語（英語）判定の基準
**外国語と判定する条件:**
- [ ] 半角英字のみ（a-z, A-Z）
- [ ] 半角英字 + スペース + ハイフンなど
- [ ] 日本語文字を含まない

---

### 3. 検索処理フロー

#### 3.1 日本語入力の場合
**遷移先**: `JpSearchPage`（検索結果ページ）

**処理フロー:**
```
1. 入力テキストを取得
2. 日本語と判定
3. API呼び出し（日本語 → 英語の単語検索）
   - エンドポイント例: `/api/search/ja-to-en?query={入力テキスト}`
   - 期待するレスポンス:
     [
       {
         word: "study",
         posTags: ["名詞", "動詞"],
         definitions: ["研究、調査", "勉強する"],
         description: "説明文"
       },
       ...
     ]
4. JpSearchPageに遷移
5. 検索結果を表示（複数の単語カード）
```

**データの受け渡し:**
- [ ] 検索クエリ（入力テキスト）
- [ ] 検索結果（単語の配列）

#### 3.2 外国語（英語）入力の場合
**遷移先**: `WordDetailPage`（単語詳細ページ）

**処理フロー:**
```
1. 入力テキストを取得
2. 外国語（英語）と判定
3. API呼び出し（英語単語の詳細取得）
   - エンドポイント例: `/api/word/detail?word={入力テキスト}`
   - 期待するレスポンス:
     {
       word: "study",
       posTags: ["名詞", "動詞"],
       definitions: ["研究、学習すること", ...],
       frequency: 85,
       difficulty: 30,
       nuance: 50,
       examples: [
         {
           english: "He studies...",
           japanese: "彼は..."
         },
         ...
       ]
     }
4. WordDetailPageに遷移
5. 単語の詳細情報を表示
```

**データの受け渡し:**
- [ ] 単語（入力テキスト）
- [ ] 単語の詳細情報（上記のレスポンス）

---

### 4. ページ遷移

#### 4.1 React Navigation / Expo Router を使用
**現在の構成**: Expo Router（ファイルベースルーティング）

**遷移方法の例:**
```typescript
import { useRouter } from 'expo-router';

const router = useRouter();

// 日本語検索の場合
router.push({
  pathname: '/search',
  params: {
    query: searchText,
    results: JSON.stringify(searchResults)
  }
});

// 英語検索の場合
router.push({
  pathname: '/word-detail',
  params: {
    word: searchText,
    data: JSON.stringify(wordData)
  }
});
```

#### 4.2 遷移時のアニメーション
- [ ] デフォルトのスライドアニメーション
- [ ] カスタムアニメーション（フェード、スケールなど）

---

### 5. ローディング状態

#### 5.1 API呼び出し中の表示
**要件**: 検索ボタンを押してからAPI応答があるまでローディング表示

- [ ] ローディングインジケーター（スピナー）を表示
- [ ] 検索ボタンを無効化（連打防止）
- [ ] タイムアウト処理（10秒以内に応答がない場合）

**実装場所:**
- 検索バー内？
- 画面全体のオーバーレイ？

---

### 6. エラーハンドリング

#### 6.1 エラーケースと対応

**ケース1: ネットワークエラー**
- API接続失敗
- 対応: エラーメッセージ表示 + 再試行ボタン

**ケース2: 単語が見つからない**
- API応答: 404 または 空の配列
- 対応: 「該当する単語が見つかりませんでした」メッセージ表示

**ケース3: 入力が不正**
- 記号のみ、数字のみなど
- 対応: 「有効な単語を入力してください」メッセージ表示

**ケース4: APIエラー（500番台）**
- サーバーエラー
- 対応: 「一時的なエラーが発生しました。しばらくしてから再試行してください」

#### 6.2 エラー表示方法
- [ ] トースト通知
- [ ] アラートダイアログ
- [ ] インラインエラーメッセージ（検索バーの下）

---

### 7. データキャッシュ

#### 7.1 検索履歴
**要件**: 過去の検索結果をキャッシュして、同じクエリの再検索を高速化

- [ ] AsyncStorage に保存
- [ ] 最大保存件数（例: 50件）
- [ ] 有効期限（例: 7日間）

#### 7.2 単語データキャッシュ
- [ ] 詳細ページで取得した単語データをキャッシュ
- [ ] メモリキャッシュ + ローカルストレージ

---

### 8. UX改善

#### 8.1 サジェスト機能（オプション）
- [ ] 入力中に候補を表示
- [ ] 過去の検索履歴から候補表示
- [ ] 人気の検索ワード表示

#### 8.2 音声入力（オプション）
- [ ] マイクボタンで音声入力
- [ ] Speech-to-Textで変換

#### 8.3 履歴表示（オプション）
- [ ] 検索バーをタップすると履歴表示
- [ ] 履歴から選択して再検索

---

## 技術的な実装方針

### 使用技術
- **状態管理**: React Context または Zustand
- **データ取得**: fetch API または Axios
- **キャッシュ**: AsyncStorage + SWR または React Query
- **ルーティング**: Expo Router

### ファイル構成（案）
```
lingooo-mobile/
├── services/
│   ├── api/
│   │   ├── search.ts           # 検索API
│   │   └── word.ts             # 単語詳細API
│   └── utils/
│       └── language-detect.ts  # 言語判定ユーティリティ
├── hooks/
│   ├── use-search.ts          # 検索ロジック
│   └── use-language-detect.ts # 言語判定ロジック
└── types/
    ├── search.ts              # 検索関連の型定義
    └── word.ts                # 単語関連の型定義
```

---

## 確認事項・未決定事項

### 1. APIエンドポイント
- [ ] バックエンドAPIは既に存在する？
- [ ] APIの仕様書はある？
- [ ] モックデータで開発を進める？

### 2. 認証
- [ ] API呼び出しに認証は必要？
- [ ] APIキーやトークンの管理方法は？

### 3. オフライン対応
- [ ] オフライン時の動作は？
- [ ] キャッシュデータのみ表示？

### 4. 多言語対応
- [ ] 英語以外の言語（フランス語、スペイン語など）も対応する？
- [ ] その場合の判定ロジックは？

---

## 次のステップ

1. ✅ 要件定義の確認・承認
2. ⬜ APIエンドポイントの確定（モックか実APIか）
3. ⬜ 言語判定ロジックの実装
4. ⬜ 検索機能の実装
5. ⬜ ページ遷移の実装
6. ⬜ エラーハンドリングの実装
7. ⬜ テスト

---

## 質問・確認事項

この要件定義について、以下の点を確認させてください：

1. **APIについて**
   - バックエンドAPIは既に存在しますか？
   - それともモックデータで開発を進めますか？

2. **言語判定**
   - 上記の日本語判定ロジックで問題ないですか？
   - 混在した入力（例: "study 勉強"）の場合はどうしますか？

3. **エラー表示**
   - エラーメッセージはどの方法で表示しますか？（トースト/アラート/インライン）

4. **オプション機能**
   - サジェスト、履歴、音声入力などは必要ですか？

5. **優先順位**
   - まずは基本的な検索→遷移機能を実装し、その後拡張する形で良いですか？
